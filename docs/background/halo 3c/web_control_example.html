<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Halo 3c Control Panel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .config {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .config h3 {
            margin-bottom: 15px;
            color: #667eea;
        }

        .config-item {
            margin-bottom: 10px;
        }

        .config-item label {
            display: inline-block;
            width: 150px;
            font-weight: bold;
        }

        .config-item input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            width: 300px;
        }

        .btn {
            background: #667eea;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }

        .btn:hover {
            background: #5568d3;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .card h2 {
            margin-bottom: 15px;
            color: #667eea;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .sensor-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }

        .sensor-item:last-child {
            border-bottom: none;
        }

        .sensor-label {
            font-weight: bold;
            color: #333;
        }

        .sensor-value {
            color: #667eea;
            font-size: 1.2em;
        }

        .status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .status.active {
            background: #ff4444;
            color: white;
        }

        .status.inactive {
            background: #44ff44;
            color: white;
        }

        .error {
            background: #ff4444;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .loading {
            text-align: center;
            color: white;
            font-size: 1.5em;
        }

        #refreshBtn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #667eea;
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        #refreshBtn:hover {
            background: #5568d3;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üå°Ô∏è Halo 3c Control Panel</h1>
            <p>Real-time Environmental Monitoring & Control</p>
        </div>

        <div class="config">
            <h3>‚öôÔ∏è Configuration</h3>
            <div class="config-item">
                <label>Halo IP:</label>
                <input type="text" id="haloIP" value="REDACTED_HALO_IP">
            </div>
            <div class="config-item">
                <label>Username:</label>
                <input type="text" id="username" value="admin">
            </div>
            <div class="config-item">
                <label>Password:</label>
                <input type="password" id="password" value="REDACTED_HALO_PASSWORD">
            </div>
            <button class="btn" onclick="saveConfig()">Save & Connect</button>
            <button class="btn" onclick="loadData()">Refresh Data</button>
        </div>

        <div id="error" class="error" style="display: none;"></div>
        <div id="loading" class="loading" style="display: none;">Loading data...</div>

        <div class="grid">
            <div class="card">
                <h2>üå°Ô∏è Environment</h2>
                <div id="environmentData"></div>
            </div>

            <div class="card">
                <h2>üí® Air Quality</h2>
                <div id="airQualityData"></div>
            </div>

            <div class="card">
                <h2>üîä Audio Sensors</h2>
                <div id="audioData"></div>
            </div>

            <div class="card">
                <h2>üèÉ Motion & Security</h2>
                <div id="motionData"></div>
            </div>

            <div class="card">
                <h2>‚ö° Relay Status</h2>
                <div id="relayData"></div>
            </div>

            <div class="card">
                <h2>üö® Active Events</h2>
                <div id="eventsData"></div>
            </div>
        </div>
    </div>

    <button id="refreshBtn" onclick="loadData()" title="Refresh">üîÑ</button>

    <script>
        let config = {
            ip: 'REDACTED_HALO_IP',
            username: 'admin',
            password: 'REDACTED_HALO_PASSWORD'
        };

        // Load config from localStorage
        const savedConfig = localStorage.getItem('haloConfig');
        if (savedConfig) {
            config = JSON.parse(savedConfig);
            document.getElementById('haloIP').value = config.ip;
            document.getElementById('username').value = config.username;
            document.getElementById('password').value = config.password;
        }

        function saveConfig() {
            config.ip = document.getElementById('haloIP').value;
            config.username = document.getElementById('username').value;
            config.password = document.getElementById('password').value;
            localStorage.setItem('haloConfig', JSON.stringify(config));
            showError('Configuration saved!', false);
            setTimeout(() => document.getElementById('error').style.display = 'none', 2000);
            loadData();
        }

        function getAuthHeader() {
            return 'Basic ' + btoa(config.username + ':' + config.password);
        }

        function showError(message, isError = true) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            errorDiv.style.background = isError ? '#ff4444' : '#44ff44';
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        async function fetchAPI(endpoint) {
            const response = await fetch(`http://${config.ip}${endpoint}`, {
                headers: {
                    'Authorization': getAuthHeader()
                }
            });
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        }

        function renderSensor(label, value, unit = '') {
            return `
                <div class="sensor-item">
                    <span class="sensor-label">${label}:</span>
                    <span class="sensor-value">${value}${unit}</span>
                </div>
            `;
        }

        async function loadData() {
            showLoading(true);
            document.getElementById('error').style.display = 'none';

            try {
                // Fetch latest sensor data
                const latest = await fetchAPI('/api/config/gstate/latest');

                // Fetch relay status
                const relay = await fetchAPI('/api/config/gstate/relay');

                // Fetch active events
                const events = await fetchAPI('/api/config/gstate/event_state');

                // Render Environment Data
                document.getElementById('environmentData').innerHTML = `
                    ${renderSensor('Temperature', latest['htsensor/ctemp']?.toFixed(1), '¬∞C')}
                    ${renderSensor('Humidity', latest['htsensor/humidity']?.toFixed(1), '%')}
                    ${renderSensor('Pressure', latest['htsensor/millibar']?.toFixed(1), ' hPa')}
                    ${renderSensor('Light', latest['luxsensor/aluxfilt']?.toFixed(0), ' lux')}
                `;

                // Render Air Quality Data
                const aqi = latest['AQI/value'] || 0;
                const aqiColor = aqi < 51 ? 'üü¢' : aqi < 101 ? 'üü°' : 'üî¥';
                document.getElementById('airQualityData').innerHTML = `
                    ${renderSensor('AQI ' + aqiColor, aqi.toFixed(0))}
                    ${renderSensor('CO2', latest['co2sensor/co2']?.toFixed(0), ' ppm')}
                    ${renderSensor('TVOC', latest['co2sensor/tvoc']?.toFixed(0), ' ppb')}
                    ${renderSensor('PM2.5', latest['pmsensor/raw/1']?.toFixed(1), ' ¬µg/m¬≥')}
                    ${renderSensor('PM10', latest['pmsensor/raw/2']?.toFixed(1), ' ¬µg/m¬≥')}
                    ${renderSensor('CO', latest['gassensor/co']?.toFixed(2), ' ppm')}
                    ${renderSensor('NO2', latest['gassensor/no2']?.toFixed(2), ' ppb')}
                `;

                // Render Audio Data
                document.getElementById('audioData').innerHTML = `
                    ${renderSensor('Noise Level', latest['audsensor/sum']?.toFixed(1), ' dB')}
                    ${renderSensor('Aggression', latest['audsensor/rms0']?.toFixed(1))}
                    ${renderSensor('Gunshot', latest['audsensor/gs']?.toFixed(1))}
                    ${renderSensor('Keyword 1', latest['audsensor/kw1']?.toFixed(1))}
                `;

                // Render Motion Data
                document.getElementById('motionData').innerHTML = `
                    ${renderSensor('Motion (PIR)', latest['pir/max']?.toFixed(1))}
                    ${renderSensor('Movement', latest['accsensor/move']?.toFixed(1))}
                    ${renderSensor('Accel X', latest['accsensor/x']?.toFixed(0), ' mg')}
                    ${renderSensor('Accel Y', latest['accsensor/y']?.toFixed(0), ' mg')}
                    ${renderSensor('Accel Z', latest['accsensor/z']?.toFixed(0), ' mg')}
                `;

                // Render Relay Status
                document.getElementById('relayData').innerHTML = `
                    ${renderSensor('Relay 1', relay.k1 ? 'üü¢ ON' : '‚ö´ OFF')}
                    ${renderSensor('Relay 2', relay.k2 ? 'üü¢ ON' : '‚ö´ OFF')}
                    ${renderSensor('Watchdog', relay.wd ? '‚úÖ' : '‚ùå')}
                    ${renderSensor('PoE Status', relay.pse ? '‚úÖ' : '‚ùå')}
                `;

                // Render Active Events
                let eventsHTML = '';
                let activeCount = 0;
                for (const [eventId, eventData] of Object.entries(events)) {
                    if (eventId === '$info$') continue;
                    const isActive = eventData.state === 1;
                    if (isActive) activeCount++;
                    eventsHTML += `
                        <div class="sensor-item">
                            <span class="sensor-label">${eventId}:</span>
                            <span class="status ${isActive ? 'active' : 'inactive'}">
                                ${isActive ? 'üö® ACTIVE' : '‚úÖ OK'}
                            </span>
                        </div>
                    `;
                }
                document.getElementById('eventsData').innerHTML =
                    `<div style="margin-bottom: 10px;"><strong>Active: ${activeCount}</strong></div>` +
                    (eventsHTML || '<div class="sensor-item">No events configured</div>');

                showLoading(false);
                showError('Data refreshed successfully!', false);
                setTimeout(() => document.getElementById('error').style.display = 'none', 2000);

            } catch (error) {
                showLoading(false);
                showError('Error loading data: ' + error.message);
                console.error('Error:', error);
            }
        }

        // Load data on page load
        window.onload = loadData;

        // Auto-refresh every 5 seconds
        setInterval(loadData, 5000);
    </script>
</body>
</html>
